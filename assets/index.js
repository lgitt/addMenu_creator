function Class(e){$.extend(this,e)}function editFile(){try{{Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator).getMostRecentWindow("navigator:browser")}mainWin&&mainWin.addMenu&&mainWin.addMenu.edit(mainWin.addMenu.FILE)}catch(e){}}function openChrome(){try{Components.classes["@mozilla.org/file/directory_service;1"].getService(Components.interfaces.nsIProperties).get("UChrm",Components.interfaces.nsILocalFile).reveal()}catch(e){showNotSupport()}}function showNotSupport(){alert("不支持该行为")}Class.prototype.constructor=Class,Class.extend=function(e){function t(){n.apply(this,arguments),this.init&&this.init(e)}var n=this;return t.prototype=Object.create(n.prototype),$.extend(t.prototype,e),t.prototype.constructor=t,t};var template=function(e,t){return e.replace(/\{([\w\.]*)\}/g,function(e,n){var a=n.split("."),s=t[a.shift()];return a.forEach(function(e){s=s[e]}),null===s||void 0===s?"":s})},jsFormat=function(e){return js_beautify(e,{indent_size:4,indent_char:" "})},toString=function(){function e(e){for(var t=0;t<n.length;t+=2)e=e.replace(n[t],n[t+1]);return'"'+e+'"'}function t(n){var a,s;switch(typeof n){case"string":return e(n);case"number":case"boolean":return n+"";case"object":if(!n)return"null";if(a=[],n instanceof Array){if(1==n.length&&null==n[0])return"[null]";for(s=0;s<n.length;s++)a[s]=null==n[s]?"":t(n[s]);return"["+a.join()+"]"}for(s in n)a[a.length]=s+":"+t(n[s]);return"{"+a.join()+"}";case"undefined":return"null";case"function":case"regexp":return n.toString();default:throw Error(typeof n)}}var n=[/(?=["\\])/g,"\\",/\n/g,"\\n",/\r/g,"\\r",/\t/g,"\\t"];return t}(),Style=Class.extend({isMenu:function(){}}),Command=Class.extend({toString:function(){var e=_.cloneDeep(this.data);return delete e._message,jsFormat(toString(e))}}),Store=Class.extend({name:"addMenu",init:function(){this.data=JSON.parse(localStorage[this.name]||"{}")},get:function(e,t){return _.isUndefined(this.data[e])?t:this.data[e]},set:function(e,t){this.data[e]=t,this.save()},save:function(){localStorage[this.name]=JSON.stringify(this.data)}}),allCommands=[];$.each(Data,function(e,t){allCommands.push(new Command({name:t.label,title:t.tooltiptext||t.label,value:e,data:t}))});var menu={styles:[{name:"页面右键",value:"page",title:"page"},{name:"标签右键",value:"tab",title:"tab"},{name:"工具菜单",value:"tool",title:"tool"},{name:"app菜单",value:"app",title:"ff28 以下为 firefox 橙菜单，以上为文件菜单"},{name:"页面右键二级",value:"PageMenu",title:"PageMenu"},{name:"标签右键二级",value:"TabMenu",title:"TabMenu"},{name:"工具菜单二级",value:"ToolMenu",title:"ToolMenu"},{name:"app菜单二级",value:"AppMenu",title:"AppMenu"}],types:[{name:"所有",value:""},{name:"复制",value:"copy"},{name:"搜索",value:"search"},{name:"打开",value:"open"},{name:"选取",value:"select"},{name:"链接",value:"link"},{name:"图像",value:"image"},{name:"输入框",value:"_input"},{name:"标签",value:"tab"},{name:"书签小工具",value:"_bookmark"},{name:"保存或下载",value:"save"},{name:"视频下载",value:"videodownload"},{name:"外部程序",value:"_app"},{name:"ff内置功能",value:"firefox"},{name:"uc脚本",value:"ucjs"},{name:"扩展",value:"addon"},{name:"左中右三建",value:"click"}],commands:allCommands},isFullSupport="chrome:"===location.protocol,MenuCtrl=Class.extend({isFullSupport:isFullSupport,model:menu,text:"",previewText:"",scriptText:"",tpl:{oneMenuItem:"{style}({value});",multiMenuItem:"{style}([{value}]);",menu:'menu = {style}({ label: "自定义菜单", });\nmenu([{value}]);',menuGroup:'menu = {style}({ _type: "group",});\nmenu([{ _type: "spacer", width: 30 }, {value}]);'},messages:[],selectedCommands:[],classHidden:isFullSupport?"":"hide",init:function(){var e=this;this.store=new Store,this.commands=this.model.commands,this.command=this.commands[0],this.style=this.store.get("style",this.model.styles[0].value),this.type=this.store.get("type",this.model.types[0].value),this.preview=this.store.get("preview",!1),this.isMenuGroup=!1,rivets.bind($("#ucjsAddmenu")[0],this),e.styleChanged(),$("#menuStyle").on("change",function(t){e.styleChanged(t)}),$("#menuType").on("change",function(t){e.changeCommands(t)}),$("#menuCommand").on("change",function(t){e.commandChanged(t)}),$("#configBtns").on("click",function(t){var n=$(t.target).attr("rv-checked")+"Clicked",a=e[n];a&&a.call(e,t)})},save:function(){this.store.data={style:this.style,type:this.type,preview:this.preview},this.store.save()},styleChanged:function(e){this.changeCommands(e);var t=-1!==this.style.toLowerCase().indexOf("menu");$("#isMenuGroup")[t?"show":"hide"]()},changeCommands:function(){var e=0===this.style.toLowerCase().indexOf("page"),t=this.type.toLowerCase();this.commands=this.model.commands.filter(function(n){return(e?!0:"p"!==n.value.toLowerCase().slice(0,1))&&(t?-1!==n.value.toLowerCase().indexOf(t):!0)}),this.command=this.commands[0]},commandChanged:function(e){this.command=_.find(this.commands,function(t){return t.value==e.target.value}),this.preview&&(this.text=this.command.toString(),this.previewText=this.text)},previewClicked:function(){this.text=this.preview?this.previewText||this.command.toString():this.scriptText},filterCommand:function(){},add:function(){this.messages=[];var e=_.contains(this.selectedCommands,this.command);e?(this.command.active=!1,_.pull(this.selectedCommands,this.command)):(this.command.active=!0,this.selectedCommands.push(this.command));var t=this.addScripts(this.selectedCommands);if(this.text=this.addText(t),this.scriptText=this.text,!e){var n=this.commands.indexOf(this.command)+1;this.command=this.commands[n]||this.command,$("#menuCommand").val(this.command.value)}},addScripts:function(e){var t=[];return _.each(e,function(e){e&&(this.addMessages(e.data,t),t.push(e.toString()))},this),t},addText:function(e){var t;if(-1===this.style.toLowerCase().indexOf("menu")){var n=1==e.length;t=n?this.tpl.oneMenuItem:this.tpl.multiMenuItem}else t=this.isMenuGroup?this.tpl.menuGroup:this.tpl.menu;var a;return a=0===e.length?"":template(t,{style:this.style,value:e.join(",")}),this.isMenuGroup&&this.messages.push("当前是单图标行，一些没图标的子菜单需要自己手动加上。"),jsFormat(a)},addMessages:function(e,t){var n=_.cloneDeep(e),a="第 "+(t.length+1)+' 条，label 为 "'+n.label+'"，';n._message&&(this.messages.push(a+n._message),delete n._message),n.keyword&&this.messages.push(a+'包含搜索关键字，请先检查自己的搜索中是否包含 <b>"'+n.keyword+'"</b> 关键字。');var s=/["']([a-z]:\\[^"']+)["']/gi;n.exec&&n.exec.match(s)&&(this.messages.push(a+'包含自定义路径，请先检查 exec 中的 <b>"'+n.exec+'"</b> 路径是否存在。'),delete n.exec);var i=toString(n),o=i.match(s);o&&this.messages.push(a+"包含自定义路径，请先检查 <b>"+o.join("</b> 和 <b>")+"</b> 路径是否存在。")},del:function(e){this.command.value in this.selectedCommands&&(this.selectedCommands[this.command.value]=null,this.add(e,!0))},clean:function(){this.commands.forEach(function(e){e.active=!1}),this.messages=[],this.selectedCommands=[],this.text=""},lineCount:function(){var e=this.text.match(/\n/g);return e?e.length+1:0},buttonName:function(){return this.command.active?"删除":"添加"}});rivets.configure({handler:function(e,t,n){this.call(n.view.models,t)}});var menuCtrl=new MenuCtrl;window.addEventListener("unload",function(){menuCtrl.save()},!1);